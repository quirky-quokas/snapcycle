"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseGraphQLServer = void 0;

var _cors = _interopRequireDefault(require("cors"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _graphqlUpload = require("graphql-upload");

var _expressApollo = require("apollo-server-express/dist/expressApollo");

var _graphqlPlaygroundHtml = require("@apollographql/graphql-playground-html");

var _graphql = require("graphql");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _middlewares = require("../middlewares");

var _requiredParameter = _interopRequireDefault(require("../requiredParameter"));

var _logger = _interopRequireDefault(require("../logger"));

var _ParseGraphQLSchema = require("./ParseGraphQLSchema");

var _ParseGraphQLController = _interopRequireWildcard(require("../Controllers/ParseGraphQLController"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ParseGraphQLServer {
  constructor(parseServer, config) {
    this.parseServer = parseServer || (0, _requiredParameter.default)('You must provide a parseServer instance!');

    if (!config || !config.graphQLPath) {
      (0, _requiredParameter.default)('You must provide a config.graphQLPath!');
    }

    this.config = config;
    this.parseGraphQLController = this.parseServer.config.parseGraphQLController;
    this.parseGraphQLSchema = new _ParseGraphQLSchema.ParseGraphQLSchema({
      parseGraphQLController: this.parseGraphQLController,
      databaseController: this.parseServer.config.databaseController,
      log: this.parseServer.config && this.parseServer.config.loggerController || _logger.default,
      graphQLCustomTypeDefs: this.config.graphQLCustomTypeDefs
    });
  }

  async _getGraphQLOptions(req) {
    return {
      schema: await this.parseGraphQLSchema.load(),
      context: {
        info: req.info,
        config: req.config,
        auth: req.auth
      }
    };
  }

  applyGraphQL(app) {
    if (!app || !app.use) {
      (0, _requiredParameter.default)('You must provide an Express.js app instance!');
    }

    const maxUploadSize = this.parseServer.config.maxUploadSize || '20mb';
    const maxFileSize = Number(maxUploadSize.slice(0, -2)) * 1024 ^ {
      kb: 1,
      mb: 2,
      gb: 3
    }[maxUploadSize.slice(-2).toLowerCase()];
    app.use(this.config.graphQLPath, (0, _graphqlUpload.graphqlUploadExpress)({
      maxFileSize
    }));
    app.use(this.config.graphQLPath, (0, _cors.default)());
    app.use(this.config.graphQLPath, _bodyParser.default.json());
    app.use(this.config.graphQLPath, _middlewares.handleParseHeaders);
    app.use(this.config.graphQLPath, _middlewares.handleParseErrors);
    app.use(this.config.graphQLPath, (0, _expressApollo.graphqlExpress)(async req => await this._getGraphQLOptions(req)));
  }

  applyPlayground(app) {
    if (!app || !app.get) {
      (0, _requiredParameter.default)('You must provide an Express.js app instance!');
    }

    app.get(this.config.playgroundPath || (0, _requiredParameter.default)('You must provide a config.playgroundPath to applyPlayground!'), (_req, res) => {
      res.setHeader('Content-Type', 'text/html');
      res.write((0, _graphqlPlaygroundHtml.renderPlaygroundPage)({
        endpoint: this.config.graphQLPath,
        subscriptionEndpoint: this.config.subscriptionsPath,
        headers: {
          'X-Parse-Application-Id': this.parseServer.config.appId,
          'X-Parse-Master-Key': this.parseServer.config.masterKey
        }
      }));
      res.end();
    });
  }

  createSubscriptions(server) {
    _subscriptionsTransportWs.SubscriptionServer.create({
      execute: _graphql.execute,
      subscribe: _graphql.subscribe,
      onOperation: async (_message, params, webSocket) => Object.assign({}, params, (await this._getGraphQLOptions(webSocket.upgradeReq)))
    }, {
      server,
      path: this.config.subscriptionsPath || (0, _requiredParameter.default)('You must provide a config.subscriptionsPath to createSubscriptions!')
    });
  }

  setGraphQLConfig(graphQLConfig) {
    return this.parseGraphQLController.updateGraphQLConfig(graphQLConfig);
  }

}

exports.ParseGraphQLServer = ParseGraphQLServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9HcmFwaFFML1BhcnNlR3JhcGhRTFNlcnZlci5qcyJdLCJuYW1lcyI6WyJQYXJzZUdyYXBoUUxTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsInBhcnNlU2VydmVyIiwiY29uZmlnIiwiZ3JhcGhRTFBhdGgiLCJwYXJzZUdyYXBoUUxDb250cm9sbGVyIiwicGFyc2VHcmFwaFFMU2NoZW1hIiwiUGFyc2VHcmFwaFFMU2NoZW1hIiwiZGF0YWJhc2VDb250cm9sbGVyIiwibG9nIiwibG9nZ2VyQ29udHJvbGxlciIsImRlZmF1bHRMb2dnZXIiLCJncmFwaFFMQ3VzdG9tVHlwZURlZnMiLCJfZ2V0R3JhcGhRTE9wdGlvbnMiLCJyZXEiLCJzY2hlbWEiLCJsb2FkIiwiY29udGV4dCIsImluZm8iLCJhdXRoIiwiYXBwbHlHcmFwaFFMIiwiYXBwIiwidXNlIiwibWF4VXBsb2FkU2l6ZSIsIm1heEZpbGVTaXplIiwiTnVtYmVyIiwic2xpY2UiLCJrYiIsIm1iIiwiZ2IiLCJ0b0xvd2VyQ2FzZSIsImJvZHlQYXJzZXIiLCJqc29uIiwiaGFuZGxlUGFyc2VIZWFkZXJzIiwiaGFuZGxlUGFyc2VFcnJvcnMiLCJhcHBseVBsYXlncm91bmQiLCJnZXQiLCJwbGF5Z3JvdW5kUGF0aCIsIl9yZXEiLCJyZXMiLCJzZXRIZWFkZXIiLCJ3cml0ZSIsImVuZHBvaW50Iiwic3Vic2NyaXB0aW9uRW5kcG9pbnQiLCJzdWJzY3JpcHRpb25zUGF0aCIsImhlYWRlcnMiLCJhcHBJZCIsIm1hc3RlcktleSIsImVuZCIsImNyZWF0ZVN1YnNjcmlwdGlvbnMiLCJzZXJ2ZXIiLCJTdWJzY3JpcHRpb25TZXJ2ZXIiLCJjcmVhdGUiLCJleGVjdXRlIiwic3Vic2NyaWJlIiwib25PcGVyYXRpb24iLCJfbWVzc2FnZSIsInBhcmFtcyIsIndlYlNvY2tldCIsIk9iamVjdCIsImFzc2lnbiIsInVwZ3JhZGVSZXEiLCJwYXRoIiwic2V0R3JhcGhRTENvbmZpZyIsImdyYXBoUUxDb25maWciLCJ1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QUFqQixFQUF5QkMsU0FBekIsS0FDWEMsTUFBTSxDQUFDQyxNQUFQLENBQ0UsRUFERixFQUVFSCxNQUZGLEdBR0UsTUFBTSxLQUFLNUMsa0JBQUwsQ0FBd0I2QyxTQUFTLENBQUNHLFVBQWxDLENBSFI7QUFKSixLQURGLEVBV0U7QUFDRVgsTUFBQUEsTUFERjtBQUVFWSxNQUFBQSxJQUFJLEVBQ0YsS0FBSzNELE1BQUwsQ0FBWXlDLGlCQUFaLElBQ0EsZ0NBQ0UscUVBREY7QUFKSixLQVhGO0FBb0JEOztBQUVEbUIsRUFBQUEsZ0JBQWdCLENBQUNDLGFBQUQsRUFBNkM7QUFDM0QsV0FBTyxLQUFLM0Qsc0JBQUwsQ0FBNEI0RCxtQkFBNUIsQ0FBZ0RELGFBQWhELENBQVA7QUFDRDs7QUE3R3NCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvcnNNaWRkbGV3YXJlIGZyb20gJ2NvcnMnO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IHsgZ3JhcGhxbFVwbG9hZEV4cHJlc3MgfSBmcm9tICdncmFwaHFsLXVwbG9hZCc7XG5pbXBvcnQgeyBncmFwaHFsRXhwcmVzcyB9IGZyb20gJ2Fwb2xsby1zZXJ2ZXItZXhwcmVzcy9kaXN0L2V4cHJlc3NBcG9sbG8nO1xuaW1wb3J0IHsgcmVuZGVyUGxheWdyb3VuZFBhZ2UgfSBmcm9tICdAYXBvbGxvZ3JhcGhxbC9ncmFwaHFsLXBsYXlncm91bmQtaHRtbCc7XG5pbXBvcnQgeyBleGVjdXRlLCBzdWJzY3JpYmUgfSBmcm9tICdncmFwaHFsJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvblNlcnZlciB9IGZyb20gJ3N1YnNjcmlwdGlvbnMtdHJhbnNwb3J0LXdzJztcbmltcG9ydCB7IGhhbmRsZVBhcnNlRXJyb3JzLCBoYW5kbGVQYXJzZUhlYWRlcnMgfSBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgcmVxdWlyZWRQYXJhbWV0ZXIgZnJvbSAnLi4vcmVxdWlyZWRQYXJhbWV0ZXInO1xuaW1wb3J0IGRlZmF1bHRMb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IFBhcnNlR3JhcGhRTFNjaGVtYSB9IGZyb20gJy4vUGFyc2VHcmFwaFFMU2NoZW1hJztcbmltcG9ydCBQYXJzZUdyYXBoUUxDb250cm9sbGVyLCB7XG4gIFBhcnNlR3JhcGhRTENvbmZpZyxcbn0gZnJvbSAnLi4vQ29udHJvbGxlcnMvUGFyc2VHcmFwaFFMQ29udHJvbGxlcic7XG5cbmNsYXNzIFBhcnNlR3JhcGhRTFNlcnZlciB7XG4gIHBhcnNlR3JhcGhRTENvbnRyb2xsZXI6IFBhcnNlR3JhcGhRTENvbnRyb2xsZXI7XG5cbiAgY29uc3RydWN0b3IocGFyc2VTZXJ2ZXIsIGNvbmZpZykge1xuICAgIHRoaXMucGFyc2VTZXJ2ZXIgPVxuICAgICAgcGFyc2VTZXJ2ZXIgfHxcbiAgICAgIHJlcXVpcmVkUGFyYW1ldGVyKCdZb3UgbXVzdCBwcm92aWRlIGEgcGFyc2VTZXJ2ZXIgaW5zdGFuY2UhJyk7XG4gICAgaWYgKCFjb25maWcgfHwgIWNvbmZpZy5ncmFwaFFMUGF0aCkge1xuICAgICAgcmVxdWlyZWRQYXJhbWV0ZXIoJ1lvdSBtdXN0IHByb3ZpZGUgYSBjb25maWcuZ3JhcGhRTFBhdGghJyk7XG4gICAgfVxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMucGFyc2VHcmFwaFFMQ29udHJvbGxlciA9IHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnLnBhcnNlR3JhcGhRTENvbnRyb2xsZXI7XG4gICAgdGhpcy5wYXJzZUdyYXBoUUxTY2hlbWEgPSBuZXcgUGFyc2VHcmFwaFFMU2NoZW1hKHtcbiAgICAgIHBhcnNlR3JhcGhRTENvbnRyb2xsZXI6IHRoaXMucGFyc2VHcmFwaFFMQ29udHJvbGxlcixcbiAgICAgIGRhdGFiYXNlQ29udHJvbGxlcjogdGhpcy5wYXJzZVNlcnZlci5jb25maWcuZGF0YWJhc2VDb250cm9sbGVyLFxuICAgICAgbG9nOlxuICAgICAgICAodGhpcy5wYXJzZVNlcnZlci5jb25maWcgJiYgdGhpcy5wYXJzZVNlcnZlci5jb25maWcubG9nZ2VyQ29udHJvbGxlcikgfHxcbiAgICAgICAgZGVmYXVsdExvZ2dlcixcbiAgICAgIGdyYXBoUUxDdXN0b21UeXBlRGVmczogdGhpcy5jb25maWcuZ3JhcGhRTEN1c3RvbVR5cGVEZWZzLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgX2dldEdyYXBoUUxPcHRpb25zKHJlcSkge1xuICAgIHJldHVybiB7XG4gICAgICBzY2hlbWE6IGF3YWl0IHRoaXMucGFyc2VHcmFwaFFMU2NoZW1hLmxvYWQoKSxcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgaW5mbzogcmVxLmluZm8sXG4gICAgICAgIGNvbmZpZzogcmVxLmNvbmZpZyxcbiAgICAgICAgYXV0aDogcmVxLmF1dGgsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBhcHBseUdyYXBoUUwoYXBwKSB7XG4gICAgaWYgKCFhcHAgfHwgIWFwcC51c2UpIHtcbiAgICAgIHJlcXVpcmVkUGFyYW1ldGVyKCdZb3UgbXVzdCBwcm92aWRlIGFuIEV4cHJlc3MuanMgYXBwIGluc3RhbmNlIScpO1xuICAgIH1cblxuICAgIGNvbnN0IG1heFVwbG9hZFNpemUgPSB0aGlzLnBhcnNlU2VydmVyLmNvbmZpZy5tYXhVcGxvYWRTaXplIHx8ICcyMG1iJztcbiAgICBjb25zdCBtYXhGaWxlU2l6ZSA9XG4gICAgICAoTnVtYmVyKG1heFVwbG9hZFNpemUuc2xpY2UoMCwgLTIpKSAqIDEwMjQpIF5cbiAgICAgIHtcbiAgICAgICAga2I6IDEsXG4gICAgICAgIG1iOiAyLFxuICAgICAgICBnYjogMyxcbiAgICAgIH1bbWF4VXBsb2FkU2l6ZS5zbGljZSgtMikudG9Mb3dlckNhc2UoKV07XG5cbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBncmFwaHFsVXBsb2FkRXhwcmVzcyh7IG1heEZpbGVTaXplIH0pKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBjb3JzTWlkZGxld2FyZSgpKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBib2R5UGFyc2VyLmpzb24oKSk7XG4gICAgYXBwLnVzZSh0aGlzLmNvbmZpZy5ncmFwaFFMUGF0aCwgaGFuZGxlUGFyc2VIZWFkZXJzKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBoYW5kbGVQYXJzZUVycm9ycyk7XG4gICAgYXBwLnVzZShcbiAgICAgIHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLFxuICAgICAgZ3JhcGhxbEV4cHJlc3MoYXN5bmMgcmVxID0+IGF3YWl0IHRoaXMuX2dldEdyYXBoUUxPcHRpb25zKHJlcSkpXG4gICAgKTtcbiAgfVxuXG4gIGFwcGx5UGxheWdyb3VuZChhcHApIHtcbiAgICBpZiAoIWFwcCB8fCAhYXBwLmdldCkge1xuICAgICAgcmVxdWlyZWRQYXJhbWV0ZXIoJ1lvdSBtdXN0IHByb3ZpZGUgYW4gRXhwcmVzcy5qcyBhcHAgaW5zdGFuY2UhJyk7XG4gICAgfVxuICAgIGFwcC5nZXQoXG4gICAgICB0aGlzLmNvbmZpZy5wbGF5Z3JvdW5kUGF0aCB8fFxuICAgICAgICByZXF1aXJlZFBhcmFtZXRlcihcbiAgICAgICAgICAnWW91IG11c3QgcHJvdmlkZSBhIGNvbmZpZy5wbGF5Z3JvdW5kUGF0aCB0byBhcHBseVBsYXlncm91bmQhJ1xuICAgICAgICApLFxuICAgICAgKF9yZXEsIHJlcykgPT4ge1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9odG1sJyk7XG4gICAgICAgIHJlcy53cml0ZShcbiAgICAgICAgICByZW5kZXJQbGF5Z3JvdW5kUGFnZSh7XG4gICAgICAgICAgICBlbmRwb2ludDogdGhpcy5jb25maWcuZ3JhcGhRTFBhdGgsXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25FbmRwb2ludDogdGhpcy5jb25maWcuc3Vic2NyaXB0aW9uc1BhdGgsXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICdYLVBhcnNlLUFwcGxpY2F0aW9uLUlkJzogdGhpcy5wYXJzZVNlcnZlci5jb25maWcuYXBwSWQsXG4gICAgICAgICAgICAgICdYLVBhcnNlLU1hc3Rlci1LZXknOiB0aGlzLnBhcnNlU2VydmVyLmNvbmZpZy5tYXN0ZXJLZXksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgY3JlYXRlU3Vic2NyaXB0aW9ucyhzZXJ2ZXIpIHtcbiAgICBTdWJzY3JpcHRpb25TZXJ2ZXIuY3JlYXRlKFxuICAgICAge1xuICAgICAgICBleGVjdXRlLFxuICAgICAgICBzdWJzY3JpYmUsXG4gICAgICAgIG9uT3BlcmF0aW9uOiBhc3luYyAoX21lc3NhZ2UsIHBhcmFtcywgd2ViU29ja2V0KSA9PlxuICAgICAgICAgIE9iamVjdC5hc3NpZ24oXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2dldEdyYXBoUUxPcHRpb25zKHdlYlNvY2tldC51cGdyYWRlUmVxKVxuICAgICAgICAgICksXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBzZXJ2ZXIsXG4gICAgICAgIHBhdGg6XG4gICAgICAgICAgdGhpcy5jb25maWcuc3Vic2NyaXB0aW9uc1BhdGggfHxcbiAgICAgICAgICByZXF1aXJlZFBhcmFtZXRlcihcbiAgICAgICAgICAgICdZb3UgbXVzdCBwcm92aWRlIGEgY29uZmlnLnN1YnNjcmlwdGlvbnNQYXRoIHRvIGNyZWF0ZVN1YnNjcmlwdGlvbnMhJ1xuICAgICAgICAgICksXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHNldEdyYXBoUUxDb25maWcoZ3JhcGhRTENvbmZpZzogUGFyc2VHcmFwaFFMQ29uZmlnKTogUHJvbWlzZSB7XG4gICAgcmV0dXJuIHRoaXMucGFyc2VHcmFwaFFMQ29udHJvbGxlci51cGRhdGVHcmFwaFFMQ29uZmlnKGdyYXBoUUxDb25maWcpO1xuICB9XG59XG5cbmV4cG9ydCB7IFBhcnNlR3JhcGhRTFNlcnZlciB9O1xuIl19