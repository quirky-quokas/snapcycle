"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = void 0;

var _graphql = require("graphql");

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var objectsMutations = _interopRequireWildcard(require("./objectsMutations"));

var _ParseGraphQLController = require("../../Controllers/ParseGraphQLController");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

const getParseClassMutationConfig = function (parseClassConfig) {
  return parseClassConfig && parseClassConfig.mutation || {};
};

const load = function (parseGraphQLSchema, parseClass, parseClassConfig) {
  const {
    className
  } = parseClass;
  const {
    create: isCreateEnabled = true,
    update: isUpdateEnabled = true,
    destroy: isDestroyEnabled = true
  } = getParseClassMutationConfig(parseClassConfig);
  const {
    classGraphQLCreateType,
    classGraphQLUpdateType
  } = parseGraphQLSchema.parseClassTypes[className];
  const createFields = {
    description: 'These are the fields used to create the object.',
    type: classGraphQLCreateType
  };
  const updateFields = {
    description: 'These are the fields used to update the object.',
    type: classGraphQLUpdateType
  };
  const classGraphQLCreateTypeFields = isCreateEnabled ? classGraphQLCreateType.getFields() : null;
  const classGraphQLUpdateTypeFields = isUpdateEnabled ? classGraphQLUpdateType.getFields() : null;

  const transformTypes = (inputType, fields) => {
    if (fields) {
      Object.keys(fields).forEach(field => {
        let inputTypeField;

        if (inputType === 'create') {
          inputTypeField = classGraphQLCreateTypeFields[field];
        } else {
          inputTypeField = classGraphQLUpdateTypeFields[field];
        }

        if (inputTypeField) {
          switch (inputTypeField.type) {
            case defaultGraphQLTypes.GEO_POINT:
              fields[field].__type = 'GeoPoint';
              break;

            case defaultGraphQLTypes.POLYGON:
              fields[field] = {
                __type: 'Polygon',
                coordinates: fields[field].map(geoPoint => [geoPoint.latitude, geoPoint.longitude])
              };
              break;
          }
        }
      });
    }
  };

  if (isCreateEnabled) {
    const createGraphQLMutationName = `create${className}`;
    parseGraphQLSchema.graphQLObjectsMutations[createGraphQLMutationName] = {
      description: `The ${createGraphQLMutationName} mutation can be used to create a new object of the ${className} class.`,
      args: {
        fields: createFields
      },
      type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.CREATE_RESULT),

      async resolve(_source, args, context) {
        try {
          const {
            fields
          } = args;
          const {
            config,
            auth,
            info
          } = context;
          transformTypes('create', fields);
          return await objectsMutations.createObject(className, fields, config, auth, info);
        } catch (e) {
          parseGraphQLSchema.handleError(e);
        }
      }

    };
  }

  if (isUpdateEnabled) {
    const updateGraphQLMutationName = `update${className}`;
    parseGraphQLSchema.graphQLObjectsMutations[updateGraphQLMutationName] = {
      description: `The ${updateGraphQLMutationName} mutation can be used to update an object of the ${className} class.`,
      args: {
        objectId: defaultGraphQLTypes.OBJECT_ID_ATT,
        fields: updateFields
      },
      type: defaultGraphQLTypes.UPDATE_RESULT,

      async resolve(_source, args, context) {
        try {
          const {
            objectId,
            fields
          } = args;
          const {
            config,
            auth,
            info
          } = context;
          transformTypes('update', fields);
          return await objectsMutations.updateObject(className, objectId, fields, config, auth, info);
        } catch (e) {
          parseGraphQLSchema.handleError(e);
        }
      }

    };
  }

  if (isDestroyEnabled) {
    const deleteGraphQLMutationName = `delete${className}`;
    parseGraphQLSchema.graphQLObjectsMutations[deleteGraphQLMutationName] = {
      description: `The ${deleteGraphQLMutationName} mutation can be used to delete an object of the ${className} class.`,
      args: {
        objectId: defaultGraphQLTypes.OBJECT_ID_ATT
      },
      type: new _graphql.GraphQLNonNull(_graphql.GraphQLBoolean),

      async resolve(_source, args, context) {
        try {
          const {
            objectId
          } = args;
          const {
            config,
            auth,
            info
          } = context;
          return await objectsMutations.deleteObject(className, objectId, config, auth, info);
        } catch (e) {
          parseGraphQLSchema.handleError(e);
        }
      }

    };
  }
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvcGFyc2VDbGFzc011dGF0aW9ucy5qcyJdLCJuYW1lcyI6WyJnZXRQYXJzZUNsYXNzTXV0YXRpb25Db25maWciLCJwYXJzZUNsYXNzQ29uZmlnIiwibXV0YXRpb24iLCJsb2FkIiwicGFyc2VHcmFwaFFMU2NoZW1hIiwicGFyc2VDbGFzcyIsImNsYXNzTmFtZSIsImNyZWF0ZSIsImlzQ3JlYXRlRW5hYmxlZCIsInVwZGF0ZSIsImlzVXBkYXRlRW5hYmxlZCIsImRlc3Ryb3kiLCJpc0Rlc3Ryb3lFbmFibGVkIiwiY2xhc3NHcmFwaFFMQ3JlYXRlVHlwZSIsImNsYXNzR3JhcGhRTFVwZGF0ZVR5cGUiLCJwYXJzZUNsYXNzVHlwZXMiLCJjcmVhdGVGaWVsZHMiLCJkZXNjcmlwdGlvbiIsInR5cGUiLCJ1cGRhdGVGaWVsZHMiLCJjbGFzc0dyYXBoUUxDcmVhdGVUeXBlRmllbGRzIiwiZ2V0RmllbGRzIiwiY2xhc3NHcmFwaFFMVXBkYXRlVHlwZUZpZWxkcyIsInRyYW5zZm9ybVR5cGVzIiwiaW5wdXRUeXBlIiwiZmllbGRzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJmaWVsZCIsImlucHV0VHlwZUZpZWxkIiwiZGVmYXVsdEdyYXBoUUxUeXBlcyIsIkdFT19QT0lOVCIsIl9fdHlwZSIsIlBPTFlHT04iLCJjb29yZGluYXRlcyIsIm1hcCIsImdlb1BvaW50IiwibGF0aXR1ZGUiLCJsb25naXR1ZGUiLCJjcmVhdGVHcmFwaFFMTXV0YXRpb25OYW1lIiwiZ3JhcGhRTE9iamVjdHNNdXRhdGlvbnMiLCJhcmdzIiwiR3JhcGhRTE5vbk51bGwiLCJDUkVBVEVfUkVTVUxUIiwicmVzb2x2ZSIsIl9zb3VyY2UiLCJjb250ZXh0IiwiY29uZmlnIiwiYXV0aCIsImluZm8iLCJvYmplY3RzTXV0YXRpb25zIiwiY3JlYXRlT2JqZWN0IiwiZSIsImhhbmRsZUVycm9yIiwidXBkYXRlR3JhcGhRTE11dGF0aW9uTmFtZSIsIm9iamVjdElkIiwiT0JKRUNUX0lEX0FUVCIsIlVQREFURV9SRVNVTFQiLCJ1cGRhdGVPYmplY3QiLCJkZWxldGVHcmFwaFFMTXV0YXRpb25OYW1lIiwiR3JhcGhRTEJvb2xlYW4iLCJkZWxldGVPYmplY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLDJCQUEyQixHQUFHLFVBQ2xDQyxnQkFEa0MsRUFFbEM7QUFDQSxTQUFRQSxnQkFBZ0IsSUFBSUEsZ0JBQWdCLENBQUNDLFFBQXRDLElBQW1ELEVBQTFEO0FBQ0QsQ0FKRDs7QUFNQSxNQUFNQyxJQUFJLEdBQUcsVUFDWEMsa0JBRFcsRUFFWEMsVUFGVyxFQUdYSixnQkFIVyxFQUlYO0FBQ0EsUUFBTTtBQUFFSyxJQUFBQTtBQUFGLE1BQWdCRCxVQUF0QjtBQUNBLFFBQU07QUFDSkUsSUFBQUEsTUFBTSxFQUFFQyxlQUFlLEdBQUcsSUFEdEI7QUFFSkMsSUFBQUEsTUFBTSxFQUFFQyxlQUFlLEdBQUcsSUFGdEI7QUFHSkMsSUFBQUEsT0FBTyxFQUFFQyxnQkFBZ0IsR0FBRztBQUh4QixNQUlGWiwyQkFBMkIsQ0FBQ0MsZ0JBQUQsQ0FKL0I7QUFNQSxRQUFNO0FBQ0pZLElBQUFBLHNCQURJO0FBRUpDLElBQUFBO0FBRkksTUFHRlYsa0JBQWtCLENBQUNXLGVBQW5CLENBQW1DVCxTQUFuQyxDQUhKO0FBS0EsUUFBTVUsWUFBWSxHQUFHO0FBQ25CQyxJQUFBQSxXQUFXLEVBQUUsaURBRE07QUFFbkJDLElBQUFBLElBQUksRUFBRUw7QUFGYSxHQUFyQjtBQUlBLFFBQU1NLFlBQVksR0FBRztBQUNuQkYsSUFBQUEsV0FBVyxFQUFFLGlEQURNO0FBRW5CQyxJQUFBQSxJQUFJLEVBQUVKO0FBRmEsR0FBckI7QUFLQSxRQUFNTSw0QkFBNEIsR0FBR1osZUFBZSxHQUNoREssc0JBQXNCLENBQUNRLFNBQXZCLEVBRGdELEdBRWhELElBRko7QUFHQSxRQUFNQyw0QkFBNEIsR0FBR1osZUFBZSxHQUNoREks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QUFDRixnQkFBTTtBQUFFUyxZQUFBQTtBQUFGLGNBQWVkLElBQXJCO0FBQ0EsZ0JBQU07QUFBRU0sWUFBQUEsTUFBRjtBQUFVQyxZQUFBQSxJQUFWO0FBQWdCQyxZQUFBQTtBQUFoQixjQUF5QkgsT0FBL0I7QUFFQSxpQkFBTyxNQUFNSSxnQkFBZ0IsQ0FBQ1csWUFBakIsQ0FDWHhELFNBRFcsRUFFWGtELFFBRlcsRUFHWFIsTUFIVyxFQUlYQyxJQUpXLEVBS1hDLElBTFcsQ0FBYjtBQU9ELFNBWEQsQ0FXRSxPQUFPRyxDQUFQLEVBQVU7QUFDVmpELFVBQUFBLGtCQUFrQixDQUFDa0QsV0FBbkIsQ0FBK0JELENBQS9CO0FBQ0Q7QUFDRjs7QUFyQnFFLEtBQXhFO0FBdUJEO0FBQ0YsQ0FwSkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHcmFwaFFMTm9uTnVsbCwgR3JhcGhRTEJvb2xlYW4gfSBmcm9tICdncmFwaHFsJztcbmltcG9ydCAqIGFzIGRlZmF1bHRHcmFwaFFMVHlwZXMgZnJvbSAnLi9kZWZhdWx0R3JhcGhRTFR5cGVzJztcbmltcG9ydCAqIGFzIG9iamVjdHNNdXRhdGlvbnMgZnJvbSAnLi9vYmplY3RzTXV0YXRpb25zJztcbmltcG9ydCB7IFBhcnNlR3JhcGhRTENsYXNzQ29uZmlnIH0gZnJvbSAnLi4vLi4vQ29udHJvbGxlcnMvUGFyc2VHcmFwaFFMQ29udHJvbGxlcic7XG5cbmNvbnN0IGdldFBhcnNlQ2xhc3NNdXRhdGlvbkNvbmZpZyA9IGZ1bmN0aW9uKFxuICBwYXJzZUNsYXNzQ29uZmlnOiA/UGFyc2VHcmFwaFFMQ2xhc3NDb25maWdcbikge1xuICByZXR1cm4gKHBhcnNlQ2xhc3NDb25maWcgJiYgcGFyc2VDbGFzc0NvbmZpZy5tdXRhdGlvbikgfHwge307XG59O1xuXG5jb25zdCBsb2FkID0gZnVuY3Rpb24oXG4gIHBhcnNlR3JhcGhRTFNjaGVtYSxcbiAgcGFyc2VDbGFzcyxcbiAgcGFyc2VDbGFzc0NvbmZpZzogP1BhcnNlR3JhcGhRTENsYXNzQ29uZmlnXG4pIHtcbiAgY29uc3QgeyBjbGFzc05hbWUgfSA9IHBhcnNlQ2xhc3M7XG4gIGNvbnN0IHtcbiAgICBjcmVhdGU6IGlzQ3JlYXRlRW5hYmxlZCA9IHRydWUsXG4gICAgdXBkYXRlOiBpc1VwZGF0ZUVuYWJsZWQgPSB0cnVlLFxuICAgIGRlc3Ryb3k6IGlzRGVzdHJveUVuYWJsZWQgPSB0cnVlLFxuICB9ID0gZ2V0UGFyc2VDbGFzc011dGF0aW9uQ29uZmlnKHBhcnNlQ2xhc3NDb25maWcpO1xuXG4gIGNvbnN0IHtcbiAgICBjbGFzc0dyYXBoUUxDcmVhdGVUeXBlLFxuICAgIGNsYXNzR3JhcGhRTFVwZGF0ZVR5cGUsXG4gIH0gPSBwYXJzZUdyYXBoUUxTY2hlbWEucGFyc2VDbGFzc1R5cGVzW2NsYXNzTmFtZV07XG5cbiAgY29uc3QgY3JlYXRlRmllbGRzID0ge1xuICAgIGRlc2NyaXB0aW9uOiAnVGhlc2UgYXJlIHRoZSBmaWVsZHMgdXNlZCB0byBjcmVhdGUgdGhlIG9iamVjdC4nLFxuICAgIHR5cGU6IGNsYXNzR3JhcGhRTENyZWF0ZVR5cGUsXG4gIH07XG4gIGNvbnN0IHVwZGF0ZUZpZWxkcyA9IHtcbiAgICBkZXNjcmlwdGlvbjogJ1RoZXNlIGFyZSB0aGUgZmllbGRzIHVzZWQgdG8gdXBkYXRlIHRoZSBvYmplY3QuJyxcbiAgICB0eXBlOiBjbGFzc0dyYXBoUUxVcGRhdGVUeXBlLFxuICB9O1xuXG4gIGNvbnN0IGNsYXNzR3JhcGhRTENyZWF0ZVR5cGVGaWVsZHMgPSBpc0NyZWF0ZUVuYWJsZWRcbiAgICA/IGNsYXNzR3JhcGhRTENyZWF0ZVR5cGUuZ2V0RmllbGRzKClcbiAgICA6IG51bGw7XG4gIGNvbnN0IGNsYXNzR3JhcGhRTFVwZGF0ZVR5cGVGaWVsZHMgPSBpc1VwZGF0ZUVuYWJsZWRcbiAgICA/IGNsYXNzR3JhcGhRTFVwZGF0ZVR5cGUuZ2V0RmllbGRzKClcbiAgICA6IG51bGw7XG5cbiAgY29uc3QgdHJhbnNmb3JtVHlwZXMgPSAoaW5wdXRUeXBlOiAnY3JlYXRlJyB8ICd1cGRhdGUnLCBmaWVsZHMpID0+IHtcbiAgICBpZiAoZmllbGRzKSB7XG4gICAgICBPYmplY3Qua2V5cyhmaWVsZHMpLmZvckVhY2goZmllbGQgPT4ge1xuICAgICAgICBsZXQgaW5wdXRUeXBlRmllbGQ7XG4gICAgICAgIGlmIChpbnB1dFR5cGUgPT09ICdjcmVhdGUnKSB7XG4gICAgICAgICAgaW5wdXRUeXBlRmllbGQgPSBjbGFzc0dyYXBoUUxDcmVhdGVUeXBlRmllbGRzW2ZpZWxkXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbnB1dFR5cGVGaWVsZCA9IGNsYXNzR3JhcGhRTFVwZGF0ZVR5cGVGaWVsZHNbZmllbGRdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpbnB1dFR5cGVGaWVsZCkge1xuICAgICAgICAgIHN3aXRjaCAoaW5wdXRUeXBlRmllbGQudHlwZSkge1xuICAgICAgICAgICAgY2FzZSBkZWZhdWx0R3JhcGhRTFR5cGVzLkdFT19QT0lOVDpcbiAgICAgICAgICAgICAgZmllbGRzW2ZpZWxkXS5fX3R5cGUgPSAnR2VvUG9pbnQnO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgZGVmYXVsdEdyYXBoUUxUeXBlcy5QT0xZR09OOlxuICAgICAgICAgICAgICBmaWVsZHNbZmllbGRdID0ge1xuICAgICAgICAgICAgICAgIF9fdHlwZTogJ1BvbHlnb24nLFxuICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBmaWVsZHNbZmllbGRdLm1hcChnZW9Qb2ludCA9PiBbXG4gICAgICAgICAgICAgICAgICBnZW9Qb2ludC5sYXRpdHVkZSxcbiAgICAgICAgICAgICAgICAgIGdlb1BvaW50LmxvbmdpdHVkZSxcbiAgICAgICAgICAgICAgICBdKSxcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgaWYgKGlzQ3JlYXRlRW5hYmxlZCkge1xuICAgIGNvbnN0IGNyZWF0ZUdyYXBoUUxNdXRhdGlvbk5hbWUgPSBgY3JlYXRlJHtjbGFzc05hbWV9YDtcbiAgICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTE9iamVjdHNNdXRhdGlvbnNbY3JlYXRlR3JhcGhRTE11dGF0aW9uTmFtZV0gPSB7XG4gICAgICBkZXNjcmlwdGlvbjogYFRoZSAke2NyZWF0ZUdyYXBoUUxNdXRhdGlvbk5hbWV9IG11dGF0aW9uIGNhbiBiZSB1c2VkIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3Qgb2YgdGhlICR7Y2xhc3NOYW1lfSBjbGFzcy5gLFxuICAgICAgYXJnczoge1xuICAgICAgICBmaWVsZHM6IGNyZWF0ZUZpZWxkcyxcbiAgICAgIH0sXG4gICAgICB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoZGVmYXVsdEdyYXBoUUxUeXBlcy5DUkVBVEVfUkVTVUxUKSxcbiAgICAgIGFzeW5jIHJlc29sdmUoX3NvdXJjZSwgYXJncywgY29udGV4dCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHsgZmllbGRzIH0gPSBhcmdzO1xuICAgICAgICAgIGNvbnN0IHsgY29uZmlnLCBhdXRoLCBpbmZvIH0gPSBjb250ZXh0O1xuXG4gICAgICAgICAgdHJhbnNmb3JtVHlwZXMoJ2NyZWF0ZScsIGZpZWxkcyk7XG5cbiAgICAgICAgICByZXR1cm4gYXdhaXQgb2JqZWN0c011dGF0aW9ucy5jcmVhdGVPYmplY3QoXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICBmaWVsZHMsXG4gICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICBhdXRoLFxuICAgICAgICAgICAgaW5mb1xuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIGlmIChpc1VwZGF0ZUVuYWJsZWQpIHtcbiAgICBjb25zdCB1cGRhdGVHcmFwaFFMTXV0YXRpb25OYW1lID0gYHVwZGF0ZSR7Y2xhc3NOYW1lfWA7XG4gICAgcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzTXV0YXRpb25zW3VwZGF0ZUdyYXBoUUxNdXRhdGlvbk5hbWVdID0ge1xuICAgICAgZGVzY3JpcHRpb246IGBUaGUgJHt1cGRhdGVHcmFwaFFMTXV0YXRpb25OYW1lfSBtdXRhdGlvbiBjYW4gYmUgdXNlZCB0byB1cGRhdGUgYW4gb2JqZWN0IG9mIHRoZSAke2NsYXNzTmFtZX0gY2xhc3MuYCxcbiAgICAgIGFyZ3M6IHtcbiAgICAgICAgb2JqZWN0SWQ6IGRlZmF1bHRHcmFwaFFMVHlwZXMuT0JKRUNUX0lEX0FUVCxcbiAgICAgICAgZmllbGRzOiB1cGRhdGVGaWVsZHMsXG4gICAgICB9LFxuICAgICAgdHlwZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5VUERBVEVfUkVTVUxULFxuICAgICAgYXN5bmMgcmVzb2x2ZShfc291cmNlLCBhcmdzLCBjb250ZXh0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgeyBvYmplY3RJZCwgZmllbGRzIH0gPSBhcmdzO1xuICAgICAgICAgIGNvbnN0IHsgY29uZmlnLCBhdXRoLCBpbmZvIH0gPSBjb250ZXh0O1xuXG4gICAgICAgICAgdHJhbnNmb3JtVHlwZXMoJ3VwZGF0ZScsIGZpZWxkcyk7XG5cbiAgICAgICAgICByZXR1cm4gYXdhaXQgb2JqZWN0c011dGF0aW9ucy51cGRhdGVPYmplY3QoXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICBvYmplY3RJZCxcbiAgICAgICAgICAgIGZpZWxkcyxcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgICBpbmZvXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHBhcnNlR3JhcGhRTFNjaGVtYS5oYW5kbGVFcnJvcihlKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgaWYgKGlzRGVzdHJveUVuYWJsZWQpIHtcbiAgICBjb25zdCBkZWxldGVHcmFwaFFMTXV0YXRpb25OYW1lID0gYGRlbGV0ZSR7Y2xhc3NOYW1lfWA7XG4gICAgcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzTXV0YXRpb25zW2RlbGV0ZUdyYXBoUUxNdXRhdGlvbk5hbWVdID0ge1xuICAgICAgZGVzY3JpcHRpb246IGBUaGUgJHtkZWxldGVHcmFwaFFMTXV0YXRpb25OYW1lfSBtdXRhdGlvbiBjYW4gYmUgdXNlZCB0byBkZWxldGUgYW4gb2JqZWN0IG9mIHRoZSAke2NsYXNzTmFtZX0gY2xhc3MuYCxcbiAgICAgIGFyZ3M6IHtcbiAgICAgICAgb2JqZWN0SWQ6IGRlZmF1bHRHcmFwaFFMVHlwZXMuT0JKRUNUX0lEX0FUVCxcbiAgICAgIH0sXG4gICAgICB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoR3JhcGhRTEJvb2xlYW4pLFxuICAgICAgYXN5bmMgcmVzb2x2ZShfc291cmNlLCBhcmdzLCBjb250ZXh0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgeyBvYmplY3RJZCB9ID0gYXJncztcbiAgICAgICAgICBjb25zdCB7IGNvbmZpZywgYXV0aCwgaW5mbyB9ID0gY29udGV4dDtcblxuICAgICAgICAgIHJldHVybiBhd2FpdCBvYmplY3RzTXV0YXRpb25zLmRlbGV0ZU9iamVjdChcbiAgICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICAgIG9iamVjdElkLFxuICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgYXV0aCxcbiAgICAgICAgICAgIGluZm9cbiAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcGFyc2VHcmFwaFFMU2NoZW1hLmhhbmRsZUVycm9yKGUpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH07XG4gIH1cbn07XG5cbmV4cG9ydCB7IGxvYWQgfTtcbiJdfQ==