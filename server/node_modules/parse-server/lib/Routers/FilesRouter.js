"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FilesRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var Middlewares = _interopRequireWildcard(require("../middlewares"));

var _node = _interopRequireDefault(require("parse/node"));

var _Config = _interopRequireDefault(require("../Config"));

var _mime = _interopRequireDefault(require("mime"));

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class FilesRouter {
  expressRouter({
    maxUploadSize = '20Mb'
  } = {}) {
    var router = _express.default.Router();

    router.get('/files/:appId/:filename', this.getHandler);
    router.post('/files', function (req, res, next) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename not provided.'));
    });
    router.post('/files/:filename', _bodyParser.default.raw({
      type: () => {
        return true;
      },
      limit: maxUploadSize
    }), // Allow uploads without Content-Type, or with any Content-Type.
    Middlewares.handleParseHeaders, this.createHandler);
    router.delete('/files/:filename', Middlewares.handleParseHeaders, Middlewares.enforceMasterKeyAccess, this.deleteHandler);
    return router;
  }

  getHandler(req, res) {
    const config = _Config.default.get(req.params.appId);

    const filesController = config.filesController;
    const filename = req.params.filename;

    const contentType = _mime.default.getType(filename);

    if (isFileStreamable(req, filesController)) {
      filesController.getFileStream(config, filename).then(stream => {
        handleFileStream(stream, req, res, contentType);
      }).catch(() => {
        res.status(404);
        res.set('Content-Type', 'text/plain');
        res.end('File not found.');
      });
    } else {
      filesController.getFileData(config, filename).then(data => {
        res.status(200);
        res.set('Content-Type', contentType);
        res.set('Content-Length', data.length);
        res.end(data);
      }).catch(() => {
        res.status(404);
        res.set('Content-Type', 'text/plain');
        res.end('File not found.');
      });
    }
  }

  createHandler(req, res, next) {
    if (!req.body || !req.body.length) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'Invalid file upload.'));
      return;
    }

    if (req.params.filename.length > 128) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename too long.'));
      return;
    }

    if (!req.params.filename.match(/^[_a-zA-Z0-9][a-zA-Z0-9@\.\ ~_-]*$/)) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename contains invalid characters.'));
      return;
    }

    const filename = req.params.filename;
    const contentType = req.get('Content-type');
    const config = req.config;
    const filesController = config.filesController;
    filesController.createFile(config, filename, req.body, contentType).then(result => {
      res.status(201);
      res.set('Location', result.url);
      res.json(result);
    }).catch(e => {
      _logger.default.error('Error creating a file: ', e);

      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, `Could not store file: ${filename}.`));
    });
  }

  deleteHandler(req, res, next) {
    const filesController = req.config.filesController;
    filesController.deleteFile(req.config, req.params.filename).then(() => {
      res.status(200); // TODO: return useful JSON here?

      res.end();
    }).catch(() => {
      next(new _node.default.Error(_node.default.Error.FILE_DELETE_ERROR, 'Could not delete file.'));
    });
  }

}

exports.FilesRouter = FilesRouter;

function isFileStreamable(req, filesController) {
  return req.get('Range') && typeof filesController.adapter.getFileStream === 'function';
}

function getRange(req) {
  const parts = req.get('Range').replace(/bytes=/, '').split('-');
  return {
    start: parseInt(parts[0], 10),
    end: parseInt(parts[1], 10)
  };
} // handleFileStream is licenced under Creative Commons Attribution 4.0 International License (https://creativecommons.org/licenses/by/4.0/).
// Author: LEROIB at weightingformypizza (https://weightingformypizza.wordpress.com/2015/06/24/stream-html5-media-content-like-video-audio-from-mongodb-using-express-and-gridstore/).


function handleFileStream(stream, req, res, contentType) {
  const buffer_size = 1024 * 1024; //1024Kb
  // Range request, partiall stream the file

  let {
    start,
    end
  } = getRange(req);
  const notEnded = !end && end !== 0;
  const notStarted = !start && start !== 0; // No end provided, we want all bytes

  if (notEnded) {
    end = stream.length - 1;
  } // No start provided, we're reading backwards


  if (notStarted) {
    start = stream.length - end;
    end = start + end - 1;
  } // Data exceeds the buffer_size, cap


  if (end - start >= buffer_size) {
    end = start + buffer_size - 1;
  }

  const contentLength = end - start + 1;
  res.writeHead(206, {
    'Content-Range': 'bytes ' + start + '-' + end + '/' + stream.length,
    'Accept-Ranges': 'bytes',
    'Content-Length': contentLength,
    'Content-Type': contentType
  });
  stream.seek(start, function () {
    // get gridFile stream
    const gridFileStream = stream.stream(true);
    let bufferAvail = 0;
    let remainingBytesToWrite = contentLength;
    let totalBytesWritten = 0; // write to response

    gridFileStream.on('data', function (data) {
      bufferAvail += data.length;

      if (bufferAvail > 0) {
        // slice returns the same buffer if overflowing
        // safe to call in any case
        const buffer = data.slice(0, remainingBytesToWrite); // write the buffer

        res.write(buffer); // increment total

        totalBytesWritten += buffer.length; // decrement remaining

        remainingBytesToWrite -= data.length; // decrement the avaialbe buffer

        bufferAvail -= buffer.length;
      } // in case of small slices, all values will be good at that point
      // we've written enough, end...


      if (totalBytesWritten >= contentLength) {
        stream.close();
        res.end();
        this.destroy();
      }
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ZpbGVzUm91dGVyLmpzIl0sIm5hbWVzIjpbIkZpbGVzUm91dGVyIiwiZXhwcmVzc1JvdXRlciIsIm1heFVwbG9hZFNpemUiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwiZ2V0IiwiZ2V0SGFuZGxlciIsInBvc3QiLCJyZXEiLCJyZXMiLCJuZXh0IiwiUGFyc2UiLCJFcnJvciIsIklOVkFMSURfRklMRV9OQU1FIiwiQm9keVBhcnNlciIsInJhdyIsInR5cGUiLCJsaW1pdCIsIk1pZGRsZXdhcmVzIiwiaGFuZGxlUGFyc2VIZWFkZXJzIiwiY3JlYXRlSGFuZGxlciIsImRlbGV0ZSIsImVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiLCJkZWxldGVIYW5kbGVyIiwiY29uZmlnIiwiQ29uZmlnIiwicGFyYW1zIiwiYXBwSWQiLCJmaWxlc0NvbnRyb2xsZXIiLCJmaWxlbmFtZSIsImNvbnRlbnRUeXBlIiwibWltZSIsImdldFR5cGUiLCJpc0ZpbGVTdHJlYW1hYmxlIiwiZ2V0RmlsZVN0cmVhbSIsInRoZW4iLCJzdHJlYW0iLCJoYW5kbGVGaWxlU3RyZWFtIiwiY2F0Y2giLCJzdGF0dXMiLCJzZXQiLCJlbmQiLCJnZXRGaWxlRGF0YSIsImRhdGEiLCJsZW5ndGgiLCJib2R5IiwiRklMRV9TQVZFX0VSUk9SIiwibWF0Y2giLCJjcmVhdGVGaWxlIiwicmVzdWx0IiwidXJsIiwianNvbiIsImUiLCJsb2dnZXIiLCJlcnJvciIsImRlbGV0ZUZpbGUiLCJGSUxFX0RFTEVURV9FUlJPUiIsImFkYXB0ZXIiLCJnZXRSYW5nZSIsInBhcnRzIiwicmVwbGFjZSIsInNwbGl0Iiwic3RhcnQiLCJwYXJzZUludCIsImJ1ZmZlcl9zaXplIiwibm90RW5kZWQiLCJub3RTdGFydGVkIiwiY29udGVudExlbmd0aCIsIndyaXRlSGVhZCIsInNlZWsiLCJncmlkRmlsZVN0cmVhbSIsImJ1ZmZlckF2YWlsIiwicmVtYWluaW5nQnl0ZXNUb1dyaXRlIiwidG90YWxCeXRlc1dyaXR0ZW4iLCJvbiIsImJ1ZmZlciIsInNsaWNlIiwid3JpdGUiLCJjbG9zZSIsImRlc3Ryb3kiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRU8sTUFBTUEsV0FBTixDQUFrQjtBQUN2QkMsRUFBQUEsYUFBYSxDQUFDO0FBQUVDLElBQUFBLGFBQWEsR0FBRztBQUFsQixNQUE2QixFQUE5QixFQUFrQztBQUM3QyxRQUFJQyxNQUFNLEdBQUdDLGlCQUFRQyxNQUFSLEVBQWI7O0FBQ0FGLElBQUFBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXLHlCQUFYLEVBQXNDLEtBQUtDLFVBQTNDO0FBRUFKLElBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZLFFBQVosRUFBc0IsVUFBU0MsR0FBVCxFQUFjQyxHQUFkLEVBQW1CQyxJQUFuQixFQUF5QjtBQUM3Q0EsTUFBQUEsSUFBSSxDQUNGLElBQUlDLGNBQU1DLEtBQVYsQ0FBZ0JELGNBQU1DLEtBQU4sQ0FBWUMsaUJBQTVCLEVBQStDLHdCQUEvQyxDQURFLENBQUo7QUFHRCxLQUpEO0FBTUFYLElBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUNFLGtCQURGLEVBRUVPLG9CQUFXQyxHQUFYLENBQWU7QUFDYkMsTUFBQUEsSUFBSSxFQUFFLE1BQU07QUFDVixlQUFPLElBQVA7QUFDRCxPQUhZO0FBSWJDLE1BQUFBLEtBQUssRUFBRWhCO0FBSk0sS0FBZixDQUZGLEVBT007QUFDSmlCLElBQUFBLFdBQVcsQ0FBQ0Msa0JBUmQsRUFTRSxLQUFLQyxhQVRQO0FBWUFsQixJQUFBQSxNQUFNLENBQUNtQixNQUFQLENBQ0Usa0JBREYsRUFFRUgsV0FBVyxDQUFDQyxrQkFGZCxFQUdFRCxXQUFXLENBQUNJLHNCQUhkLEVBSUUsS0FBS0MsYUFKUDtBQU1BLFdBQU9yQixNQUFQO0FBQ0Q7O0FBRURJLEVBQUFBLFVBQVUsQ0FBQ0UsR0FBRCxFQUFNQyxHQUFOLEVBQVc7QUFDbkIsVUFBTWUsTUFB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QUNBLFVBQUkyQixXQUFXLEdBQUcsQ0FBbEIsRUFBcUI7QUFDbkI7QUFDQTtBQUNBLGNBQU1JLE1BQU0sR0FBR2hDLElBQUksQ0FBQ2lDLEtBQUwsQ0FBVyxDQUFYLEVBQWNKLHFCQUFkLENBQWYsQ0FIbUIsQ0FJbkI7O0FBQ0EvRCxRQUFBQSxHQUFHLENBQUNvRSxLQUFKLENBQVVGLE1BQVYsRUFMbUIsQ0FNbkI7O0FBQ0FGLFFBQUFBLGlCQUFpQixJQUFJRSxNQUFNLENBQUMvQixNQUE1QixDQVBtQixDQVFuQjs7QUFDQTRCLFFBQUFBLHFCQUFxQixJQUFJN0IsSUFBSSxDQUFDQyxNQUE5QixDQVRtQixDQVVuQjs7QUFDQTJCLFFBQUFBLFdBQVcsSUFBSUksTUFBTSxDQUFDL0IsTUFBdEI7QUFDRCxPQWRzQyxDQWV2QztBQUNBOzs7QUFDQSxVQUFJNkIsaUJBQWlCLElBQUlOLGFBQXpCLEVBQXdDO0FBQ3RDL0IsUUFBQUEsTUFBTSxDQUFDMEMsS0FBUDtBQUNBckUsUUFBQUEsR0FBRyxDQUFDZ0MsR0FBSjtBQUNBLGFBQUtzQyxPQUFMO0FBQ0Q7QUFDRixLQXRCRDtBQXVCRCxHQTlCRDtBQStCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IEJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0ICogYXMgTWlkZGxld2FyZXMgZnJvbSAnLi4vbWlkZGxld2FyZXMnO1xuaW1wb3J0IFBhcnNlIGZyb20gJ3BhcnNlL25vZGUnO1xuaW1wb3J0IENvbmZpZyBmcm9tICcuLi9Db25maWcnO1xuaW1wb3J0IG1pbWUgZnJvbSAnbWltZSc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5cbmV4cG9ydCBjbGFzcyBGaWxlc1JvdXRlciB7XG4gIGV4cHJlc3NSb3V0ZXIoeyBtYXhVcGxvYWRTaXplID0gJzIwTWInIH0gPSB7fSkge1xuICAgIHZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIHJvdXRlci5nZXQoJy9maWxlcy86YXBwSWQvOmZpbGVuYW1lJywgdGhpcy5nZXRIYW5kbGVyKTtcblxuICAgIHJvdXRlci5wb3N0KCcvZmlsZXMnLCBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgICAgbmV4dChcbiAgICAgICAgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfRklMRV9OQU1FLCAnRmlsZW5hbWUgbm90IHByb3ZpZGVkLicpXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgcm91dGVyLnBvc3QoXG4gICAgICAnL2ZpbGVzLzpmaWxlbmFtZScsXG4gICAgICBCb2R5UGFyc2VyLnJhdyh7XG4gICAgICAgIHR5cGU6ICgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcbiAgICAgICAgbGltaXQ6IG1heFVwbG9hZFNpemUsXG4gICAgICB9KSwgLy8gQWxsb3cgdXBsb2FkcyB3aXRob3V0IENvbnRlbnQtVHlwZSwgb3Igd2l0aCBhbnkgQ29udGVudC1UeXBlLlxuICAgICAgTWlkZGxld2FyZXMuaGFuZGxlUGFyc2VIZWFkZXJzLFxuICAgICAgdGhpcy5jcmVhdGVIYW5kbGVyXG4gICAgKTtcblxuICAgIHJvdXRlci5kZWxldGUoXG4gICAgICAnL2ZpbGVzLzpmaWxlbmFtZScsXG4gICAgICBNaWRkbGV3YXJlcy5oYW5kbGVQYXJzZUhlYWRlcnMsXG4gICAgICBNaWRkbGV3YXJlcy5lbmZvcmNlTWFzdGVyS2V5QWNjZXNzLFxuICAgICAgdGhpcy5kZWxldGVIYW5kbGVyXG4gICAgKTtcbiAgICByZXR1cm4gcm91dGVyO1xuICB9XG5cbiAgZ2V0SGFuZGxlcihyZXEsIHJlcykge1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQocmVxLnBhcmFtcy5hcHBJZCk7XG4gICAgY29uc3QgZmlsZXNDb250cm9sbGVyID0gY29uZmlnLmZpbGVzQ29udHJvbGxlcjtcbiAgICBjb25zdCBmaWxlbmFtZSA9IHJlcS5wYXJhbXMuZmlsZW5hbWU7XG4gICAgY29uc3QgY29udGVudFR5cGUgPSBtaW1lLmdldFR5cGUoZmlsZW5hbWUpO1xuICAgIGlmIChpc0ZpbGVTdHJlYW1hYmxlKHJlcSwgZmlsZXNDb250cm9sbGVyKSkge1xuICAgICAgZmlsZXNDb250cm9sbGVyXG4gICAgICAgIC5nZXRGaWxlU3RyZWFtKGNvbmZpZywgZmlsZW5hbWUpXG4gICAgICAgIC50aGVuKHN0cmVhbSA9PiB7XG4gICAgICAgICAgaGFuZGxlRmlsZVN0cmVhbShzdHJlYW0sIHJlcSwgcmVzLCBjb250ZW50VHlwZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDQpO1xuICAgICAgICAgIHJlcy5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJyk7XG4gICAgICAgICAgcmVzLmVuZCgnRmlsZSBub3QgZm91bmQuJyk7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWxlc0NvbnRyb2xsZXJcbiAgICAgICAgLmdldEZpbGVEYXRhKGNvbmZpZywgZmlsZW5hbWUpXG4gICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgIHJlcy5zdGF0dXMoMjAwKTtcbiAgICAgICAgICByZXMuc2V0KCdDb250ZW50LVR5cGUnLCBjb250ZW50VHlwZSk7XG4gICAgICAgICAgcmVzLnNldCgnQ29udGVudC1MZW5ndGgnLCBkYXRhLmxlbmd0aCk7XG4gICAgICAgICAgcmVzLmVuZChkYXRhKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICByZXMuc3RhdHVzKDQwNCk7XG4gICAgICAgICAgcmVzLnNldCgnQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKTtcbiAgICAgICAgICByZXMuZW5kKCdGaWxlIG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlSGFuZGxlcihyZXEsIHJlcywgbmV4dCkge1xuICAgIGlmICghcmVxLmJvZHkgfHwgIXJlcS5ib2R5Lmxlbmd0aCkge1xuICAgICAgbmV4dChcbiAgICAgICAgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLkZJTEVfU0FWRV9FUlJPUiwgJ0ludmFsaWQgZmlsZSB1cGxvYWQuJylcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHJlcS5wYXJhbXMuZmlsZW5hbWUubGVuZ3RoID4gMTI4KSB7XG4gICAgICBuZXh0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5WQUxJRF9GSUxFX05BTUUsICdGaWxlbmFtZSB0b28gbG9uZy4nKVxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5wYXJhbXMuZmlsZW5hbWUubWF0Y2goL15bX2EtekEtWjAtOV1bYS16QS1aMC05QFxcLlxcIH5fLV0qJC8pKSB7XG4gICAgICBuZXh0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuSU5WQUxJRF9GSUxFX05BTUUsXG4gICAgICAgICAgJ0ZpbGVuYW1lIGNvbnRhaW5zIGludmFsaWQgY2hhcmFjdGVycy4nXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZW5hbWUgPSByZXEucGFyYW1zLmZpbGVuYW1lO1xuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVxLmdldCgnQ29udGVudC10eXBlJyk7XG4gICAgY29uc3QgY29uZmlnID0gcmVxLmNvbmZpZztcbiAgICBjb25zdCBmaWxlc0NvbnRyb2xsZXIgPSBjb25maWcuZmlsZXNDb250cm9sbGVyO1xuXG4gICAgZmlsZXNDb250cm9sbGVyXG4gICAgICAuY3JlYXRlRmlsZShjb25maWcsIGZpbGVuYW1lLCByZXEuYm9keSwgY29udGVudFR5cGUpXG4gICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICByZXMuc3RhdHVzKDIwMSk7XG4gICAgICAgIHJlcy5zZXQoJ0xvY2F0aW9uJywgcmVzdWx0LnVybCk7XG4gICAgICAgIHJlcy5qc29uKHJlc3VsdCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIGEgZmlsZTogJywgZSk7XG4gICAgICAgIG5leHQoXG4gICAgICAgICAgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICAgICAgUGFyc2UuRXJyb3IuRklMRV9TQVZFX0VSUk9SLFxuICAgICAgICAgICAgYENvdWxkIG5vdCBzdG9yZSBmaWxlOiAke2ZpbGVuYW1lfS5gXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSk7XG4gIH1cblxuICBkZWxldGVIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgY29uc3QgZmlsZXNDb250cm9sbGVyID0gcmVxLmNvbmZpZy5maWxlc0NvbnRyb2xsZXI7XG4gICAgZmlsZXNDb250cm9sbGVyXG4gICAgICAuZGVsZXRlRmlsZShyZXEuY29uZmlnLCByZXEucGFyYW1zLmZpbGVuYW1lKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXMuc3RhdHVzKDIwMCk7XG4gICAgICAgIC8vIFRPRE86IHJldHVybiB1c2VmdWwgSlNPTiBoZXJlP1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgbmV4dChcbiAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICBQYXJzZS5FcnJvci5GSUxFX0RFTEVURV9FUlJPUixcbiAgICAgICAgICAgICdDb3VsZCBub3QgZGVsZXRlIGZpbGUuJ1xuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRmlsZVN0cmVhbWFibGUocmVxLCBmaWxlc0NvbnRyb2xsZXIpIHtcbiAgcmV0dXJuIChcbiAgICByZXEuZ2V0KCdSYW5nZScpICYmXG4gICAgdHlwZW9mIGZpbGVzQ29udHJvbGxlci5hZGFwdGVyLmdldEZpbGVTdHJlYW0gPT09ICdmdW5jdGlvbidcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0UmFuZ2UocmVxKSB7XG4gIGNvbnN0IHBhcnRzID0gcmVxXG4gICAgLmdldCgnUmFuZ2UnKVxuICAgIC5yZXBsYWNlKC9ieXRlcz0vLCAnJylcbiAgICAuc3BsaXQoJy0nKTtcbiAgcmV0dXJuIHsgc3RhcnQ6IHBhcnNlSW50KHBhcnRzWzBdLCAxMCksIGVuZDogcGFyc2VJbnQocGFydHNbMV0sIDEwKSB9O1xufVxuXG4vLyBoYW5kbGVGaWxlU3RyZWFtIGlzIGxpY2VuY2VkIHVuZGVyIENyZWF0aXZlIENvbW1vbnMgQXR0cmlidXRpb24gNC4wIEludGVybmF0aW9uYWwgTGljZW5zZSAoaHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LzQuMC8pLlxuLy8gQXV0aG9yOiBMRVJPSUIgYXQgd2VpZ2h0aW5nZm9ybXlwaXp6YSAoaHR0cHM6Ly93ZWlnaHRpbmdmb3JteXBpenphLndvcmRwcmVzcy5jb20vMjAxNS8wNi8yNC9zdHJlYW0taHRtbDUtbWVkaWEtY29udGVudC1saWtlLXZpZGVvLWF1ZGlvLWZyb20tbW9uZ29kYi11c2luZy1leHByZXNzLWFuZC1ncmlkc3RvcmUvKS5cbmZ1bmN0aW9uIGhhbmRsZUZpbGVTdHJlYW0oc3RyZWFtLCByZXEsIHJlcywgY29udGVudFR5cGUpIHtcbiAgY29uc3QgYnVmZmVyX3NpemUgPSAxMDI0ICogMTAyNDsgLy8xMDI0S2JcbiAgLy8gUmFuZ2UgcmVxdWVzdCwgcGFydGlhbGwgc3RyZWFtIHRoZSBmaWxlXG4gIGxldCB7IHN0YXJ0LCBlbmQgfSA9IGdldFJhbmdlKHJlcSk7XG5cbiAgY29uc3Qgbm90RW5kZWQgPSAhZW5kICYmIGVuZCAhPT0gMDtcbiAgY29uc3Qgbm90U3RhcnRlZCA9ICFzdGFydCAmJiBzdGFydCAhPT0gMDtcbiAgLy8gTm8gZW5kIHByb3ZpZGVkLCB3ZSB3YW50IGFsbCBieXRlc1xuICBpZiAobm90RW5kZWQpIHtcbiAgICBlbmQgPSBzdHJlYW0ubGVuZ3RoIC0gMTtcbiAgfVxuICAvLyBObyBzdGFydCBwcm92aWRlZCwgd2UncmUgcmVhZGluZyBiYWNrd2FyZHNcbiAgaWYgKG5vdFN0YXJ0ZWQpIHtcbiAgICBzdGFydCA9IHN0cmVhbS5sZW5ndGggLSBlbmQ7XG4gICAgZW5kID0gc3RhcnQgKyBlbmQgLSAxO1xuICB9XG5cbiAgLy8gRGF0YSBleGNlZWRzIHRoZSBidWZmZXJfc2l6ZSwgY2FwXG4gIGlmIChlbmQgLSBzdGFydCA+PSBidWZmZXJfc2l6ZSkge1xuICAgIGVuZCA9IHN0YXJ0ICsgYnVmZmVyX3NpemUgLSAxO1xuICB9XG5cbiAgY29uc3QgY29udGVudExlbmd0aCA9IGVuZCAtIHN0YXJ0ICsgMTtcblxuICByZXMud3JpdGVIZWFkKDIwNiwge1xuICAgICdDb250ZW50LVJhbmdlJzogJ2J5dGVzICcgKyBzdGFydCArICctJyArIGVuZCArICcvJyArIHN0cmVhbS5sZW5ndGgsXG4gICAgJ0FjY2VwdC1SYW5nZXMnOiAnYnl0ZXMnLFxuICAgICdDb250ZW50LUxlbmd0aCc6IGNvbnRlbnRMZW5ndGgsXG4gICAgJ0NvbnRlbnQtVHlwZSc6IGNvbnRlbnRUeXBlLFxuICB9KTtcblxuICBzdHJlYW0uc2VlayhzdGFydCwgZnVuY3Rpb24oKSB7XG4gICAgLy8gZ2V0IGdyaWRGaWxlIHN0cmVhbVxuICAgIGNvbnN0IGdyaWRGaWxlU3RyZWFtID0gc3RyZWFtLnN0cmVhbSh0cnVlKTtcbiAgICBsZXQgYnVmZmVyQXZhaWwgPSAwO1xuICAgIGxldCByZW1haW5pbmdCeXRlc1RvV3JpdGUgPSBjb250ZW50TGVuZ3RoO1xuICAgIGxldCB0b3RhbEJ5dGVzV3JpdHRlbiA9IDA7XG4gICAgLy8gd3JpdGUgdG8gcmVzcG9uc2VcbiAgICBncmlkRmlsZVN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIGJ1ZmZlckF2YWlsICs9IGRhdGEubGVuZ3RoO1xuICAgICAgaWYgKGJ1ZmZlckF2YWlsID4gMCkge1xuICAgICAgICAvLyBzbGljZSByZXR1cm5zIHRoZSBzYW1lIGJ1ZmZlciBpZiBvdmVyZmxvd2luZ1xuICAgICAgICAvLyBzYWZlIHRvIGNhbGwgaW4gYW55IGNhc2VcbiAgICAgICAgY29uc3QgYnVmZmVyID0gZGF0YS5zbGljZSgwLCByZW1haW5pbmdCeXRlc1RvV3JpdGUpO1xuICAgICAgICAvLyB3cml0ZSB0aGUgYnVmZmVyXG4gICAgICAgIHJlcy53cml0ZShidWZmZXIpO1xuICAgICAgICAvLyBpbmNyZW1lbnQgdG90YWxcbiAgICAgICAgdG90YWxCeXRlc1dyaXR0ZW4gKz0gYnVmZmVyLmxlbmd0aDtcbiAgICAgICAgLy8gZGVjcmVtZW50IHJlbWFpbmluZ1xuICAgICAgICByZW1haW5pbmdCeXRlc1RvV3JpdGUgLT0gZGF0YS5sZW5ndGg7XG4gICAgICAgIC8vIGRlY3JlbWVudCB0aGUgYXZhaWFsYmUgYnVmZmVyXG4gICAgICAgIGJ1ZmZlckF2YWlsIC09IGJ1ZmZlci5sZW5ndGg7XG4gICAgICB9XG4gICAgICAvLyBpbiBjYXNlIG9mIHNtYWxsIHNsaWNlcywgYWxsIHZhbHVlcyB3aWxsIGJlIGdvb2QgYXQgdGhhdCBwb2ludFxuICAgICAgLy8gd2UndmUgd3JpdHRlbiBlbm91Z2gsIGVuZC4uLlxuICAgICAgaWYgKHRvdGFsQnl0ZXNXcml0dGVuID49IGNvbnRlbnRMZW5ndGgpIHtcbiAgICAgICAgc3RyZWFtLmNsb3NlKCk7XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuIl19